## 1. 문서 개요

### 1.1 목적
본 문서는 K-SectorRadar 프로젝트의 데이터 모델, 데이터베이스 스키마, REST API 설계를 정의한다.

### 1.2 범위
본 문서는 데이터 모델 정의, 데이터베이스 스키마 설계, API 엔드포인트 설계, 요청/응답 형식 등을 포함한다.

### 1.3 참고 문서
- 요구사항 명세서
- 시스템 설계서
- 데이터 수집 및 처리 설계서

---

## 2. 데이터 모델

### 2.1 종목 정보 (Stock/ETF)

#### 2.1.1 JSON 스키마
```json
{
  "ticker": "034020",
  "name": "두산에너빌리티",
  "type": "STOCK",
  "theme": "원자력/전력플랜트/에너지",
  "fee": null,
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-11-13T21:22:11Z"
}
```

#### 2.1.2 필드 설명
| 필드 | 타입 | 필수 | 설명 |
|:---|:---|:---|:---|
| `ticker` | string | ✓ | 종목 코드 (고유 식별자, PK) |
| `name` | string | ✓ | 종목명 |
| `type` | string | ✓ | 종목 타입 (STOCK 또는 ETF) |
| `theme` | string | - | 테마 분류 |
| `fee` | number\|null | - | 수수료 (ETF만 해당, null 가능) |
| `createdAt` | string (ISO 8601) | ✓ | 생성일시 |
| `updatedAt` | string (ISO 8601) | ✓ | 최종 수정일시 |

### 2.2 가격 데이터 (Price)

#### 2.2.1 JSON 스키마
```json
{
  "ticker": "034020",
  "date": "2025-11-13",
  "timestamp": "2025-11-13T15:30:00Z",
  "currentPrice": 83100,
  "changeRate": 2.5,
  "changeAmount": 2025,
  "openPrice": 82000,
  "highPrice": 83500,
  "lowPrice": 81800,
  "volume": 7900000,
  "weeklyChangeRate": 5.2,
  "previousClose": 81075
}
```

#### 2.2.2 필드 설명
| 필드 | 타입 | 필수 | 설명 |
|:---|:---|:---|:---|
| `ticker` | string | ✓ | 종목 코드 |
| `date` | string (YYYY-MM-DD) | ✓ | 거래일자 |
| `timestamp` | string (ISO 8601) | ✓ | 수집 시각 |
| `currentPrice` | number | ✓ | 현재가 |
| `changeRate` | number | - | 등락률 (%) |
| `changeAmount` | number | - | 등락액 |
| `openPrice` | number | - | 시가 |
| `highPrice` | number | - | 고가 |
| `lowPrice` | number | - | 저가 |
| `volume` | number | - | 거래량 |
| `weeklyChangeRate` | number | - | 주간 등락률 (%) |
| `previousClose` | number | - | 전일 종가 |

### 2.3 매매 동향 (Trading Trend)

#### 2.3.1 JSON 스키마
```json
{
  "ticker": "034020",
  "date": "2025-11-13",
  "timestamp": "2025-11-13T15:30:00Z",
  "individual": -860000,
  "institution": 220000,
  "foreign": 650000,
  "total": 10000
}
```

#### 2.3.2 필드 설명
| 필드 | 타입 | 필수 | 설명 |
|:---|:---|:---|:---|
| `ticker` | string | ✓ | 종목 코드 |
| `date` | string (YYYY-MM-DD) | ✓ | 거래일자 |
| `timestamp` | string (ISO 8601) | ✓ | 수집 시각 |
| `individual` | number | - | 개인 투자자 거래량 (순매수: +, 순매도: -) |
| `institution` | number | - | 기관 투자자 거래량 |
| `foreign` | number | - | 외국인 투자자 거래량 |
| `total` | number | - | 총 거래량 |

### 2.4 뉴스 데이터 (News)

#### 2.4.1 JSON 스키마
```json
{
  "id": "news_001",
  "ticker": "034020",
  "title": "두산에너빌리티, 원자력 사업 확대",
  "url": "https://...",
  "source": "매일경제",
  "publishedAt": "2025-11-13T10:00:00Z",
  "collectedAt": "2025-11-13T10:05:00Z"
}
```

#### 2.4.2 필드 설명
| 필드 | 타입 | 필수 | 설명 |
|:---|:---|:---|:---|
| `id` | string | ✓ | 뉴스 고유 ID (PK) |
| `ticker` | string | ✓ | 관련 종목 코드 |
| `title` | string | ✓ | 뉴스 제목 |
| `url` | string | ✓ | 뉴스 URL |
| `source` | string | - | 출처 |
| `publishedAt` | string (ISO 8601) | - | 발행일시 |
| `collectedAt` | string (ISO 8601) | ✓ | 수집일시 |

### 2.5 차트 데이터 (Chart Data)

#### 2.5.1 JSON 스키마
```json
{
  "ticker": "034020",
  "date": "2025-11-13",
  "data": [
    {
      "date": "2025-11-08",
      "open": 80000,
      "high": 81000,
      "low": 79500,
      "close": 80500,
      "volume": 5000000
    }
  ]
}
```

#### 2.5.2 필드 설명
| 필드 | 타입 | 필수 | 설명 |
|:---|:---|:---|:---|
| `ticker` | string | ✓ | 종목 코드 |
| `date` | string (YYYY-MM-DD) | ✓ | 기준일자 |
| `data` | array | ✓ | 차트 데이터 배열 (최근 6일) |
| `data[].date` | string | ✓ | 거래일자 |
| `data[].open` | number | ✓ | 시가 |
| `data[].high` | number | ✓ | 고가 |
| `data[].low` | number | ✓ | 저가 |
| `data[].close` | number | ✓ | 종가 |
| `data[].volume` | number | ✓ | 거래량 |

---

## 3. 데이터베이스 스키마

### 3.1 데이터베이스 개요
- **DBMS**: MySQL 또는 PostgreSQL
- **인코딩**: UTF-8
- **타임존**: UTC

### 3.2 테이블 설계

#### 3.2.1 stocks 테이블
```sql
CREATE TABLE stocks (
  ticker VARCHAR(10) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  type VARCHAR(10) NOT NULL CHECK (type IN ('STOCK', 'ETF')),
  theme VARCHAR(200),
  fee DECIMAL(10, 6),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_type (type),
  INDEX idx_theme (theme)
);
```

#### 3.2.2 prices 테이블
```sql
CREATE TABLE prices (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  ticker VARCHAR(10) NOT NULL,
  date DATE NOT NULL,
  timestamp TIMESTAMP NOT NULL,
  current_price DECIMAL(12, 2) NOT NULL,
  change_rate DECIMAL(6, 2),
  change_amount DECIMAL(12, 2),
  open_price DECIMAL(12, 2),
  high_price DECIMAL(12, 2),
  low_price DECIMAL(12, 2),
  volume BIGINT,
  weekly_change_rate DECIMAL(6, 2),
  previous_close DECIMAL(12, 2),
  INDEX idx_ticker_date (ticker, date),
  INDEX idx_ticker_timestamp (ticker, timestamp),
  FOREIGN KEY (ticker) REFERENCES stocks(ticker) ON DELETE CASCADE
);
```

#### 3.2.3 trading_trends 테이블
```sql
CREATE TABLE trading_trends (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  ticker VARCHAR(10) NOT NULL,
  date DATE NOT NULL,
  timestamp TIMESTAMP NOT NULL,
  individual BIGINT,
  institution BIGINT,
  foreign_investor BIGINT,
  total BIGINT,
  INDEX idx_ticker_date (ticker, date),
  INDEX idx_ticker_timestamp (ticker, timestamp),
  FOREIGN KEY (ticker) REFERENCES stocks(ticker) ON DELETE CASCADE
);
```

#### 3.2.4 news 테이블
```sql
CREATE TABLE news (
  id VARCHAR(50) PRIMARY KEY,
  ticker VARCHAR(10) NOT NULL,
  title VARCHAR(500) NOT NULL,
  url VARCHAR(1000) NOT NULL,
  source VARCHAR(100),
  published_at TIMESTAMP,
  collected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_ticker_published (ticker, published_at),
  INDEX idx_published_at (published_at),
  FOREIGN KEY (ticker) REFERENCES stocks(ticker) ON DELETE CASCADE,
  UNIQUE KEY uk_url (url(255))
);
```

---

## 4. API 설계

### 4.1 API 개요
- **기본 URL**: `/api`
- **인증**: 초기 버전은 인증 없음 (향후 확장 가능)
- **응답 형식**: JSON
- **문자 인코딩**: UTF-8

### 4.2 API 엔드포인트

#### 4.2.1 종목 목록 조회
- **메서드**: `GET`
- **경로**: `/api/stocks`
- **설명**: 전체 종목 목록을 조회합니다.
- **쿼리 파라미터**:
  | 파라미터 | 타입 | 필수 | 설명 |
  |:---|:---|:---|:---|
  | `type` | string | - | 종목 타입 필터 (STOCK, ETF) |
  | `theme` | string | - | 테마 필터 |
  | `limit` | number | - | 조회 개수 제한 (기본값: 100) |
  | `offset` | number | - | 페이지 오프셋 (기본값: 0) |

- **응답 예시**:
```json
{
  "success": true,
  "data": {
    "stocks": [
      {
        "ticker": "034020",
        "name": "두산에너빌리티",
        "type": "STOCK",
        "theme": "원자력/전력플랜트/에너지",
        "fee": null
      }
    ],
    "total": 50,
    "limit": 100,
    "offset": 0
  },
  "message": "",
  "timestamp": "2025-11-13T21:23:43Z"
}
```

#### 4.2.2 종목 상세 조회
- **메서드**: `GET`
- **경로**: `/api/stocks/{ticker}`
- **설명**: 특정 종목의 상세 정보를 조회합니다.
- **경로 파라미터**:
  | 파라미터 | 타입 | 필수 | 설명 |
  |:---|:---|:---|:---|
  | `ticker` | string | ✓ | 종목 코드 |

- **응답 예시**:
```json
{
  "success": true,
  "data": {
    "ticker": "034020",
    "name": "두산에너빌리티",
    "type": "STOCK",
    "theme": "원자력/전력플랜트/에너지",
    "fee": null,
    "createdAt": "2025-01-01T00:00:00Z",
    "updatedAt": "2025-11-13T21:22:11Z"
  },
  "message": "",
  "timestamp": "2025-11-13T21:23:43Z"
}
```

#### 4.2.3 가격 데이터 조회
- **메서드**: `GET`
- **경로**: `/api/stocks/{ticker}/price`
- **설명**: 특정 종목의 가격 데이터를 조회합니다.
- **경로 파라미터**:
  | 파라미터 | 타입 | 필수 | 설명 |
  |:---|:---|:---|:---|
  | `ticker` | string | ✓ | 종목 코드 |

- **쿼리 파라미터**:
  | 파라미터 | 타입 | 필수 | 설명 |
  |:---|:---|:---|:---|
  | `date` | string | - | 특정 날짜 조회 (YYYY-MM-DD, 기본값: 최신) |

- **응답 예시**:
```json
{
  "success": true,
  "data": {
    "ticker": "034020",
    "date": "2025-11-13",
    "timestamp": "2025-11-13T15:30:00Z",
    "currentPrice": 83100,
    "changeRate": 2.5,
    "changeAmount": 2025,
    "openPrice": 82000,
    "highPrice": 83500,
    "lowPrice": 81800,
    "volume": 7900000,
    "weeklyChangeRate": 5.2,
    "previousClose": 81075
  },
  "message": "",
  "timestamp": "2025-11-13T21:23:43Z"
}
```

#### 4.2.4 매매 동향 조회
- **메서드**: `GET`
- **경로**: `/api/stocks/{ticker}/trading`
- **설명**: 특정 종목의 매매 동향 데이터를 조회합니다.
- **경로 파라미터**:
  | 파라미터 | 타입 | 필수 | 설명 |
  |:---|:---|:---|:---|
  | `ticker` | string | ✓ | 종목 코드 |

- **쿼리 파라미터**:
  | 파라미터 | 타입 | 필수 | 설명 |
  |:---|:---|:---|:---|
  | `date` | string | - | 특정 날짜 조회 (YYYY-MM-DD, 기본값: 최신) |

- **응답 예시**:
```json
{
  "success": true,
  "data": {
    "ticker": "034020",
    "date": "2025-11-13",
    "timestamp": "2025-11-13T15:30:00Z",
    "individual": -860000,
    "institution": 220000,
    "foreign": 650000,
    "total": 10000
  },
  "message": "",
  "timestamp": "2025-11-13T21:23:43Z"
}
```

#### 4.2.5 뉴스 조회
- **메서드**: `GET`
- **경로**: `/api/stocks/{ticker}/news`
- **설명**: 특정 종목의 뉴스 목록을 조회합니다.
- **경로 파라미터**:
  | 파라미터 | 타입 | 필수 | 설명 |
  |:---|:---|:---|:---|
  | `ticker` | string | ✓ | 종목 코드 |

- **쿼리 파라미터**:
  | 파라미터 | 타입 | 필수 | 설명 |
  |:---|:---|:---|:---|
  | `limit` | number | - | 조회 개수 제한 (기본값: 10, 최대: 50) |
  | `offset` | number | - | 페이지 오프셋 (기본값: 0) |

- **응답 예시**:
```json
{
  "success": true,
  "data": {
    "news": [
      {
        "id": "news_001",
        "ticker": "034020",
        "title": "두산에너빌리티, 원자력 사업 확대",
        "url": "https://...",
        "source": "매일경제",
        "publishedAt": "2025-11-13T10:00:00Z",
        "collectedAt": "2025-11-13T10:05:00Z"
      }
    ],
    "total": 15,
    "limit": 10,
    "offset": 0
  },
  "message": "",
  "timestamp": "2025-11-13T21:23:43Z"
}
```

#### 4.2.6 차트 데이터 조회
- **메서드**: `GET`
- **경로**: `/api/stocks/{ticker}/chart`
- **설명**: 특정 종목의 차트 데이터를 조회합니다.
- **경로 파라미터**:
  | 파라미터 | 타입 | 필수 | 설명 |
  |:---|:---|:---|:---|
  | `ticker` | string | ✓ | 종목 코드 |

- **쿼리 파라미터**:
  | 파라미터 | 타입 | 필수 | 설명 |
  |:---|:---|:---|:---|
  | `days` | number | - | 조회 기간 (일, 기본값: 6, 최대: 30) |

- **응답 예시**:
```json
{
  "success": true,
  "data": {
    "ticker": "034020",
    "date": "2025-11-13",
    "data": [
      {
        "date": "2025-11-08",
        "open": 80000,
        "high": 81000,
        "low": 79500,
        "close": 80500,
        "volume": 5000000
      }
    ]
  },
  "message": "",
  "timestamp": "2025-11-13T21:23:43Z"
}
```

#### 4.2.7 데이터 갱신
- **메서드**: `POST`
- **경로**: `/api/refresh`
- **설명**: 모든 종목의 데이터를 수동으로 갱신합니다.
- **요청 본문**:
```json
{
  "tickers": ["034020", "005930"]
}
```
  | 필드 | 타입 | 필수 | 설명 |
  |:---|:---|:---|:---|
  | `tickers` | array | - | 갱신할 종목 코드 배열 (없으면 전체 갱신) |

- **응답 예시**:
```json
{
  "success": true,
  "data": {
    "updated": 2,
    "failed": 0,
    "tickers": ["034020", "005930"]
  },
  "message": "데이터 갱신이 완료되었습니다.",
  "timestamp": "2025-11-13T21:23:43Z"
}
```

### 4.3 API 응답 형식

#### 4.3.1 성공 응답
```json
{
  "success": true,
  "data": {},
  "message": "",
  "timestamp": "2025-11-13T21:23:43Z"
}
```

#### 4.3.2 에러 응답
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "에러 메시지",
    "details": {}
  },
  "timestamp": "2025-11-13T21:23:43Z"
}
```

#### 4.3.3 에러 코드
| 코드 | HTTP 상태 | 설명 |
|:---|:---|:---|
| `NOT_FOUND` | 404 | 리소스를 찾을 수 없음 |
| `INVALID_PARAMETER` | 400 | 잘못된 파라미터 |
| `INTERNAL_ERROR` | 500 | 내부 서버 오류 |
| `SERVICE_UNAVAILABLE` | 503 | 서비스 이용 불가 |

---

## 5. 데이터 검증 규칙

### 5.1 가격 데이터 검증
- 현재가 > 0
- 고가 >= 저가
- 시가, 고가, 저가 범위 내에 현재가 존재
- 거래량 >= 0
- 등락률 범위: -100% ~ +100% (이론적 한계)

### 5.2 매매 동향 검증
- 개인 + 기관 + 외국인 = 총 거래량 (근사치, ±5% 허용)
- 각 값이 숫자 타입인지 확인
- 거래량 값의 합리성 검증

### 5.3 뉴스 데이터 검증
- 제목이 비어있지 않음 (최소 1자)
- URL이 유효한 형식 (http:// 또는 https://)
- 발행일시가 유효한 날짜 형식 (ISO 8601)
- URL 중복 방지

### 5.4 종목 정보 검증
- ticker는 6자리 숫자 문자열
- name은 최소 1자, 최대 100자
- type은 'STOCK' 또는 'ETF'만 허용
- fee는 ETF인 경우 필수, STOCK인 경우 null

---

## 6. 캐싱 전략

### 6.1 캐시 구조 (Redis)
- **캐시 키 패턴**: `{prefix}:{type}:{ticker}`
- **예시**:
  - `ksr:stock:034020`: 종목 정보
  - `ksr:price:034020`: 최신 가격 데이터
  - `ksr:trading:034020`: 최신 매매 동향
  - `ksr:news:034020`: 최신 뉴스 목록
  - `ksr:chart:034020`: 차트 데이터

### 6.2 캐시 TTL (Time To Live)
| 데이터 타입 | TTL | 설명 |
|:---|:---|:---|
| 종목 정보 | 1시간 | 변경 빈도가 낮음 |
| 가격 데이터 | 30초 | 실시간 데이터 |
| 매매 동향 | 30초 | 실시간 데이터 |
| 뉴스 데이터 | 10분 | 업데이트 주기와 동일 |
| 차트 데이터 | 1분 | 일일 데이터 |

### 6.3 캐시 무효화 전략
- 데이터 수집 시 자동 캐시 업데이트
- 수동 갱신 시 관련 캐시 삭제 후 재생성
- TTL 만료 시 자동 삭제

---

## 7. 성능 최적화

### 7.1 데이터베이스 최적화
- 인덱스 설계: 자주 조회되는 필드에 인덱스 생성
- 쿼리 최적화: JOIN 최소화, 필요한 컬럼만 SELECT
- 파티셔닝: prices 테이블은 날짜 기준 파티셔닝 고려

### 7.2 API 최적화
- 응답 데이터 압축 (gzip)
- 페이지네이션 적용
- 병렬 처리: 여러 종목 조회 시 병렬 처리
- Rate Limiting: API 호출 제한 (예: 초당 100회)

---
